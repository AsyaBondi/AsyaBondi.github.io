<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeAnime - –î–µ—Ç–∞–ª–∏ –∞–Ω–∏–º–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding-top: var(--tg-content-safe-area-inset-top);
            padding-bottom: var(--tg-content-safe-area-inset-bottom);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px 0;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }

        .back-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin-right: 12px;
            color: var(--tg-theme-button-color);
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–Ω–∏–º–µ */
        .anime-header {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .poster {
            width: 150px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .anime-info {
            flex: 1;
        }

        .anime-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color);
        }

        .anime-subtitle {
            color: var(--tg-theme-hint-color);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .anime-description {
            color: var(--tg-theme-text-color);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .anime-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .meta-item {
            background: var(--tg-theme-secondary-bg-color);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            color: var(--tg-theme-text-color);
        }

        /* –°–µ–∫—Ü–∏–∏ */
        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color);
        }

        /* –í—ã–±–æ—Ä –æ–∑–≤—É—á–∫–∏ */
        .translation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .translation-button {
            padding: 12px;
            border: 2px solid var(--tg-theme-secondary-bg-color);
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .translation-button:hover,
        .translation-button.selected {
            border-color: var(--tg-theme-button-color);
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        /* –í—ã–±–æ—Ä —Å–µ—Ä–∏–∏ */
        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .episode-button {
            padding: 12px 8px;
            border: 2px solid var(--tg-theme-secondary-bg-color);
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 500;
        }

        .episode-button:hover,
        .episode-button.selected {
            border-color: var(--tg-theme-button-color);
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            position: fixed;
            bottom: calc(16px + var(--tg-content-safe-area-inset-bottom));
            left: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .action-button {
            flex: 1;
            padding: 14px;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
        }

        .secondary-button {
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color);
        }

        .spinner {
            border: 4px solid var(--tg-theme-secondary-bg-color);
            border-top: 4px solid var(--tg-theme-button-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –°–∫—Ä—ã—Ç—ã–µ —Å–µ–∫—Ü–∏–∏ */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-button" onclick="goBack()">‚Üê</button>
            <div class="header-title">–î–µ—Ç–∞–ª–∏ –∞–Ω–∏–º–µ</div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="action-button secondary-button" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="action-button" id="watchButton" onclick="watchAnime()" disabled>–°–º–æ—Ç—Ä–µ—Ç—å</button>
    </div>

    <script>
        let currentAnime = null;
        let selectedTranslation = null;
        let selectedEpisode = null;
        let isSerial = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
        document.addEventListener('DOMContentLoaded', function() {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.setHeaderColor('bg_color');

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
            const urlParams = getQueryStrings();
            if (urlParams.animeId) {
                loadAnimeDetails(urlParams.animeId);
            } else {
                showError('–ù–µ —É–∫–∞–∑–∞–Ω ID –∞–Ω–∏–º–µ');
            }
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
        function getQueryStrings() {
            var assoc = {};
            var decode = function (s) { return decodeURIComponent(s.replace(/\+/g, " ")); };
            var queryString = location.search.substring(1);
            var keyValues = queryString.split('&');

            for(var i in keyValues) {
                var key = keyValues[i].split('=');
                if (key.length > 1) {
                    assoc[decode(key[0])] = decode(key[1]);
                }
            }

            return assoc;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∏–º–µ
        function loadAnimeDetails(animeId) {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –±–æ—Ç—É
            window.Telegram.WebApp.sendData(JSON.stringify({
                action: 'get_anime_details',
                animeId: animeId
            }));
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∏–º–µ
        function showAnimeDetails(data) {
            currentAnime = data;
            isSerial = data.typeKodi !== 'movie';

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="anime-header">
                    <img src="${data.poster || '/placeholder.jpg'}" alt="${data.name}" class="poster" onerror="this.src='/placeholder.jpg'">
                    <div class="anime-info">
                        <div class="anime-title">${data.name}</div>
                        <div class="anime-subtitle">${data.origName}</div>
                        <div class="anime-description">${data.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
                        <div class="anime-meta">
                            <span class="meta-item">${data.year} –≥–æ–¥</span>
                            <span class="meta-item">${data.typeKodi === 'movie' ? '–§–∏–ª—å–º' : '–°–µ—Ä–∏–∞–ª'}</span>
                            ${data.genres ? data.genres.map(g => `<span class="meta-item">${g}</span>`).join('') : ''}
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üéµ –í—ã–±–µ—Ä–∏—Ç–µ –æ–∑–≤—É—á–∫—É</div>
                    <div id="translations" class="translation-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–∑–≤—É—á–µ–∫...</div>
                        </div>
                    </div>
                </div>

                <div class="section ${isSerial ? '' : 'hidden'}" id="episodesSection">
                    <div class="section-title">üì∫ –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–∏—é</div>
                    <div id="episodes" class="episode-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–∏–π...</div>
                        </div>
                    </div>
                </div>
            `;

            // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–∑–≤—É—á–µ–∫
            loadTranslations();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–∑–≤—É—á–µ–∫
        function loadTranslations() {
            window.Telegram.WebApp.sendData(JSON.stringify({
                action: 'get_translations',
                animeId: currentAnime.id
            }));
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–∑–≤—É—á–µ–∫
        function showTranslations(translations) {
            const container = document.getElementById('translations');
            if (!translations || translations.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--tg-theme-hint-color);">–û–∑–≤—É—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            container.innerHTML = translations.map(translation => `
                <button class="translation-button" onclick="selectTranslation('${translation.id}', '${translation.title}')">
                    ${translation.title}
                </button>
            `).join('');
        }

        // –í—ã–±–æ—Ä –æ–∑–≤—É—á–∫–∏
        function selectTranslation(id, title) {
            selectedTranslation = { id, title };

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.translation-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–∏–π –µ—Å–ª–∏ —Å–µ—Ä–∏–∞–ª
            if (isSerial) {
                loadEpisodes();
            } else {
                selectedEpisode = 1;
                updateWatchButton();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–∏–π
        function loadEpisodes() {
            document.getElementById('episodesSection').classList.remove('hidden');

            window.Telegram.WebApp.sendData(JSON.stringify({
                action: 'get_episodes',
                animeId: currentAnime.id,
                translationId: selectedTranslation.id
            }));
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ—Ä–∏–π
        function showEpisodes(episodeCount) {
            const container = document.getElementById('episodes');
            const episodes = [];

            for (let i = 1; i <= episodeCount; i++) {
                episodes.push(`<button class="episode-button" onclick="selectEpisode(${i})">${i}</button>`);
            }

            container.innerHTML = episodes.join('');
        }

        // –í—ã–±–æ—Ä —Å–µ—Ä–∏–∏
        function selectEpisode(episodeNum) {
            selectedEpisode = episodeNum;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.episode-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            updateWatchButton();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–°–º–æ—Ç—Ä–µ—Ç—å"
        function updateWatchButton() {
            const button = document.getElementById('watchButton');
            if (selectedTranslation && (selectedEpisode || !isSerial)) {
                button.disabled = false;
                button.textContent = `–°–º–æ—Ç—Ä–µ—Ç—å ${isSerial ? `—Å–µ—Ä–∏—é ${selectedEpisode}` : '—Ñ–∏–ª—å–º'}`;
            } else {
                button.disabled = true;
                button.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–∑–≤—É—á–∫—É';
            }
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∏–º–µ
        function watchAnime() {
            if (!selectedTranslation || (!selectedEpisode && isSerial)) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ–∑–≤—É—á–∫—É –∏ —Å–µ—Ä–∏—é', 'error');
                return;
            }

            window.Telegram.WebApp.sendData(JSON.stringify({
                action: 'watch_anime',
                animeId: currentAnime.id,
                translationId: selectedTranslation.id,
                episode: selectedEpisode
            }));
        }

        // –ù–∞–∑–∞–¥
        function goBack() {
            window.Telegram.WebApp.sendData(JSON.stringify({
                action: 'go_back'
            }));
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message, type = 'info') {
            window.Telegram.WebApp.showAlert(message);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--tg-theme-hint-color);">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                    <div>${message}</div>
                    <button class="action-button secondary-button" style="margin-top: 20px; width: auto;" onclick="goBack()">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
                </div>
            `;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
        window.addEventListener('message', function(event) {
            if (event.data) {
                const data = event.data;

                switch(data.type) {
                    case 'anime_details':
                        showAnimeDetails(data.anime);
                        break;
                    case 'translations':
                        showTranslations(data.translations);
                        break;
                    case 'episodes':
                        showEpisodes(data.episodeCount);
                        break;
                    case 'error':
                        showError(data.message);
                        break;
                }
            }
        });
    </script>
</body>
</html>