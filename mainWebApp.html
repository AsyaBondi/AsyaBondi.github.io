<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeAnime - –ü–æ–∏—Å–∫ –∞–Ω–∏–º–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Telegram WebApp —Å—Ç–∏–ª–∏ -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding-top: var(--tg-content-safe-area-inset-top);
            padding-bottom: var(--tg-content-safe-area-inset-bottom);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        /* –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ */
        .search-container {
            margin-bottom: 20px;
            position: sticky;
            top: var(--tg-content-safe-area-inset-top);
            background: var(--tg-theme-bg-color);
            padding: 16px 0;
            z-index: 100;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--tg-theme-button-color, #007AFF);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            outline: none;
        }

        .search-input:focus {
            border-color: var(--tg-theme-button-color);
        }

        .search-button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∞–Ω–∏–º–µ */
        .anime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .anime-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .anime-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .anime-poster {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .anime-info {
            padding: 12px;
        }

        .anime-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--tg-theme-text-color);
        }

        .anime-year {
            color: var(--tg-theme-hint-color, #666);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .anime-type {
            display: inline-block;
            padding: 4px 8px;
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #fff);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color);
        }

        .spinner {
            border: 4px solid var(--tg-theme-secondary-bg-color);
            border-top: 4px solid var(--tg-theme-button-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--tg-theme-hint-color);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            position: fixed;
            bottom: calc(16px + var(--tg-content-safe-area-inset-bottom));
            left: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .action-button {
            flex: 1;
            padding: 12px;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .secondary-button {
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∏–º–µ...">
            <button id="searchButton" class="search-button">üîç –ò—Å–∫–∞—Ç—å</button>
        </div>

        <div id="results">
            <div class="empty-state">
                <div class="empty-icon">üé¨</div>
                <div>–ù–∞—á–Ω–∏—Ç–µ –ø–æ–∏—Å–∫, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∞–Ω–∏–º–µ</div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="action-button secondary-button" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div id="debugInfo" style="margin-top: 20px; padding: 16px; background: var(--tg-theme-secondary-bg-color); border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong>üìä –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
            <div>
                <button onclick="clearLogs()" style="font-size: 10px; padding: 2px 6px; border: none; border-radius: 4px; background: #ff6b6b; color: white; cursor: pointer; margin-right: 4px;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button onclick="toggleDebug()" style="font-size: 10px; padding: 2px 6px; border: none; border-radius: 4px; background: var(--tg-theme-button-color); color: white; cursor: pointer;">–°–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="debugLogs"></div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—Ç–ª–∞–¥–∫–∏ -->
    <div style="margin-top: 10px; text-align: center;">
        <button onclick="toggleDebug()" style="font-size: 11px; padding: 4px 8px; border: none; border-radius: 6px; background: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); cursor: pointer;">üêõ –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</button>
    </div>

    <script>
        let currentAnime = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        function logToPage(message, type = 'info') {
            const logsContainer = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üìù';

            const logEntry = document.createElement('div');
            logEntry.style.margin = '4px 0';
            logEntry.style.padding = '4px';
            logEntry.style.borderRadius = '4px';
            logEntry.style.background = type === 'error' ? '#ffebee' : type === 'success' ? '#e8f5e8' : '#f5f5f5';
            logEntry.innerHTML = `<span style="color: #666; font-size: 11px;">${timestamp}</span> ${emoji} ${message}`;

            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            console.log(`[${timestamp}] ${message}`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –±–ª–æ–∫–∞ —Å –æ—Ç–ª–∞–¥–∫–æ–π
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            const isVisible = debugInfo.style.display !== 'none';

            if (isVisible) {
                debugInfo.style.display = 'none';
                logToPage('–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∞');
            } else {
                debugInfo.style.display = 'block';
                logToPage('–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞–Ω–∞', 'success');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤
        function clearLogs() {
            const logsContainer = document.getElementById('debugLogs');
            logsContainer.innerHTML = '';
            logToPage('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'success');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
        document.addEventListener('DOMContentLoaded', function() {
            logToPage('WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            logToPage('Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω: ' + !!window.Telegram?.WebApp);

            if (!window.Telegram?.WebApp) {
                logToPage('Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!', 'error');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('debugInfo').style.display = 'block';
                document.body.innerHTML = '<div style="padding: 20px; text-align: center;">–û—à–∏–±–∫–∞: Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram.</div>';
                return;
            }

            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();

            logToPage('WebApp –≥–æ—Ç–æ–≤, –≤–µ—Ä—Å–∏—è: ' + window.Telegram.WebApp.version);
            logToPage('–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ' + window.Telegram.WebApp.platform);

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            window.Telegram.WebApp.setHeaderColor('bg_color');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('searchButton').addEventListener('click', searchAnime);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAnime();
                }
            });

            logToPage('WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
        });

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∞–Ω–∏–º–µ
        function searchAnime() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                logToPage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∏–º–µ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'error');
                return;
            }

            showLoading();

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –±–æ—Ç—É - –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —á–∞—Ç–µ
            const data = JSON.stringify({
                action: 'search',
                query: query
            });

            logToPage('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç: ' + data);

            try {
                window.Telegram.WebApp.sendData(data);
                logToPage('–ü–æ–∏—Å–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç –±–æ—Ç–∞', 'success');

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                setTimeout(() => {
                    window.Telegram.WebApp.close();
                }, 300);
            } catch (error) {
                logToPage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('debugInfo').style.display = 'block';
                // –£–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('results').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ùå</div>
                        <div>–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–æ—Ç–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</div>
                    </div>
                `;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading() {
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>–ò—â—É –∞–Ω–∏–º–µ...</div>
                </div>
            `;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        function showResults(animeList) {
            const results = document.getElementById('results');

            if (!animeList || animeList.length === 0) {
                results.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.</div>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="anime-grid">
                    ${animeList.map(anime => `
                        <div class="anime-card" onclick="selectAnime('${anime.id}')">
                            <img src="${anime.poster || '/placeholder.jpg'}" alt="${anime.name}" class="anime-poster" onerror="this.src='/placeholder.jpg'">
                            <div class="anime-info">
                                <div class="anime-title">${anime.name}</div>
                                <div class="anime-year">${anime.origName}</div>
                                <div class="anime-year">${anime.year} –≥–æ–¥</div>
                                <span class="anime-type">${anime.typeKodi === 'movie' ? '–§–∏–ª—å–º' : '–°–µ—Ä–∏–∞–ª'}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            results.innerHTML = html;
        }

        // –í—ã–±–æ—Ä –∞–Ω–∏–º–µ
        function selectAnime(animeId) {
            window.Telegram.WebApp.sendData(JSON.stringify({
                action: 'select_anime',
                animeId: animeId
            }));
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message, type = 'info') {
            window.Telegram.WebApp.showAlert(message);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
        window.Telegram.WebApp.onEvent('mainButtonClicked', function() {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞ (–µ—Å–ª–∏ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç)
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'anime_search_results') {
                showResults(event.data.results);
            }
        });
    </script>
</body>
</html>